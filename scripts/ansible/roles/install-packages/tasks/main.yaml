---

- name: Create keyring directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory

- name: Download K8s apt key
  ansible.builtin.get_url:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    dest: /etc/apt/keyrings/kubernetes-archive-keyring.gpg
    mode: '0644'
    force: true

- name: Download Docker apt key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/debian/gpg
    dest: /etc/apt/keyrings/docker.gpg
    mode: '0644'
    force: true

- name: Create K8s source for apt
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/kubernetes.list
    line: "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"
    create: yes

- name: Create Docker source for apt
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/docker.list
    line: "deb [arch=arm64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bullseye stable"
    create: yes

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes

- name: Install packages
  ansible.builtin.apt:
    name: "{{ package }}"
  loop: "{{ packages }}"
  loop_control:
    loop_var: package

- name: Mark K8s packages
  ansible.builtin.shell:
    cmd: "apt-mark hold kubelet kubeadm kubectl containerd.io"

- name: Cleanup
  ansible.builtin.apt:
    clean: yes